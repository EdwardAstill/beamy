"""Validation tests for LoadedMember integration (1D ↔ 3D convergence).These tests verify that the frame-based LoadedMember produces consistent resultswith classical analytical benchmarks."""import numpy as npfrom sectiony.library import rhsfrom beamy.beam1d.beam import Beam1Dfrom beamy.beam1d.analysis import LoadedMemberfrom beamy.core.material import Materialfrom beamy.core.support import Supportfrom beamy.core.loads import LoadCase, PointForcedef test_cantilever_end_load():    """Test cantilever beam with point load at free end.        Classical solution:    - Deflection at end: δ = -PL³/(3EI)    - Max moment (at fixed end): M = -PL    - Max shear: V = -P    """    print("\n" + "="*80)    print("TEST: Cantilever with End Load")    print("="*80)        # Geometry and material    L = 5.0  # m    P = -1000.0  # N (downward)    E = 200e9  # Pa    section = rhs(b=0.1, h=0.2, t=0.005, r=0.0)    I = section.Iy    A = section.A        # Expected results    expected_deflection_end = -P * L**3 / (3 * E * I)    expected_moment_fixed = -P * L    expected_shear = -P        print(f"L = {L} m, P = {P} N, E = {E} Pa, I = {I} m⁴")    print(f"Expected: δ_end = {expected_deflection_end:.6e} m")    print(f"Expected: M_fixed = {expected_moment_fixed:.1f} N⋅m")    print(f"Expected: V = {expected_shear:.1f} N")        # Setup beam    material = Material(name="Steel", E=E, G=80e9)    beam = Beam1D(        L=L,        material=material,        section=section,        supports=[Support(x=0.0, type="111111")]  # Fixed at x=0    )        # Load case    loads = LoadCase(name="End Load")    loads.add_point_force(PointForce(        point=np.array([L, 0.0, 0.0]),        force=np.array([0.0, 0.0, P])    ))        # Analyze    print(f"\nFrame Backend:")    print("-" * 40)        lm = LoadedMember(beam=beam, loads=loads)        # Check moment at fixed end (x=0)    bending = lm.bending("y", points=101)    moment_at_fixed = bending.action.at(0.0)    print(f"  M(0) = {moment_at_fixed:.1f} N⋅m (expected: {expected_moment_fixed:.1f})")        # Check moment at free end (should be ~0)    moment_at_free = bending.action.at(L)    print(f"  M(L) = {moment_at_free:.1f} N⋅m (expected: ~0)")        # Check shear (should be constant)    shear = lm.shear("z", points=101)    shear_avg = np.mean(shear.action._values)    print(f"  V_avg = {shear_avg:.1f} N (expected: {expected_shear:.1f})")        # Verify moment    moment_error = abs(moment_at_fixed - expected_moment_fixed)    assert moment_error < abs(expected_moment_fixed) * 0.01, \        f"Moment error {moment_error:.2e} > 1% of expected"        # Verify shear    shear_error = abs(shear_avg - expected_shear)    assert shear_error < abs(expected_shear) * 0.01, \        f"Shear error {shear_error:.2e} > 1% of expected"        print("\n✓ Cantilever test passed")def test_simply_supported_center_load():    """Test simply supported beam with point load at center.        Classical solution:    - Deflection at center: δ = -PL³/(48EI)    - Max moment (at center): M = PL/4    - Reactions: R1 = R2 = P/2    """    print("\n" + "="*80)    print("TEST: Simply Supported Beam with Center Load")    print("="*80)        # Geometry and material    L = 10.0  # m    P = -5000.0  # N (downward)    E = 200e9  # Pa    section = rhs(b=0.15, h=0.25, t=0.006, r=0.0)    I = section.Iy        # Expected results    expected_deflection_center = -P * L**3 / (48 * E * I)    expected_moment_center = -P * L / 4  # Negative because downward load    expected_reaction = -P / 2        print(f"L = {L} m, P = {P} N, E = {E} Pa, I = {I} m⁴")    print(f"Expected: δ_center = {expected_deflection_center:.6e} m")    print(f"Expected: M_center = {expected_moment_center:.1f} N⋅m")    print(f"Expected: R1 = R2 = {expected_reaction:.1f} N")        # Setup beam    material = Material(name="Steel", E=E, G=80e9)    beam = Beam1D(        L=L,        material=material,        section=section,        supports=[            Support(x=0.0, type="110000"),  # Pinned at x=0            Support(x=L, type="010000")     # Roller at x=L        ]    )        # Load case    loads = LoadCase(name="Center Load")    loads.add_point_force(PointForce(        point=np.array([L/2, 0.0, 0.0]),        force=np.array([0.0, 0.0, P])    ))        # Analyze    print(f"\nFrame Backend:")    print("-" * 40)        lm = LoadedMember(beam=beam, loads=loads)        # Check moment at center    bending = lm.bending("y", points=201)    moment_at_center = bending.action.at(L/2)    print(f"  M(L/2) = {moment_at_center:.1f} N⋅m (expected: {expected_moment_center:.1f})")        # Check moments at supports (should be ~0)    moment_at_left = bending.action.at(0.0)    moment_at_right = bending.action.at(L)    print(f"  M(0) = {moment_at_left:.1f} N⋅m (expected: ~0)")    print(f"  M(L) = {moment_at_right:.1f} N⋅m (expected: ~0)")        # Check reactions    reactions = lm._frame_analysis.reactions    print(f"  Reactions: {reactions}")        # Verify moment at center    moment_error = abs(moment_at_center - expected_moment_center)    assert moment_error < abs(expected_moment_center) * 0.01, \        f"Moment error {moment_error:.2e} > 1%"        # Verify moments at supports are near zero    assert abs(moment_at_left) < 1.0, f"Moment at left support too large"    assert abs(moment_at_right) < 1.0, f"Moment at right support too large"        print("\n✓ Simply supported test passed")def test_multi_load():    """Test beam with multiple point loads."""    print("\n" + "="*80)    print("TEST: Beam with Multiple Loads")    print("="*80)        # Setup a more complex load case    L = 8.0    section = rhs(b=0.12, h=0.3, t=0.008, r=0.0)    material = Material(name="Steel", E=210e9, G=80e9)        beam = Beam1D(        L=L,        material=material,        section=section,        supports=[            Support(x=0.0, type="111000"),  # Fixed translation, free rotation            Support(x=L, type="010000")     # Vertical support only        ]    )        loads = LoadCase(name="Multi-Load")    loads.add_point_force(PointForce(        point=np.array([L/3, 0.0, 0.0]),        force=np.array([0.0, 0.0, -2000.0])    ))    loads.add_point_force(PointForce(        point=np.array([2*L/3, 0.0, 0.0]),        force=np.array([0.0, 0.0, -3000.0])    ))        # Analyze    lm = LoadedMember(beam=beam, loads=loads)        # Get results    points = 101    bending = lm.bending("y", points=points)    shear = lm.shear("z", points=points)        # Basic checks    print(f"\nResults:")    print(f"  Max moment: {bending.action.abs_max:.1f} N⋅m")    print(f"  Max shear: {shear.action.abs_max:.1f} N")        # Verify we get reasonable results    assert bending.action.abs_max > 0, "Bending moment should be non-zero"    assert shear.action.abs_max > 0, "Shear force should be non-zero"        print("\n✓ Multi-load test passed")if __name__ == "__main__":    try:        test_cantilever_end_load()        test_simply_supported_center_load()        test_multi_load()                print("\n" + "="*80)        print("ALL TESTS PASSED ✓")        print("="*80)            except Exception as e:        print(f"\n{'='*80}")        print(f"TEST FAILED: {e}")        print("="*80)        import traceback        traceback.print_exc()        exit(1)